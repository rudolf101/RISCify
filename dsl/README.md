# Руководство по конфигурации дизассемблера для добавления поддержки расширений RISC-V

## Файлы

Находяшиеся в этом каталоге файлы с расширением `.yml`
используются для описания форматов инструкций RISC-V.
При генерации используются все файлы.

## Формат файла

Каждый файл состоит из 4-разделов:
- `Arguments` — содержит список аргументов инструкций (опциональный раздел);
- `Fields` — содержит список полей инструкций (опциональный раздел);
- `Restricts` — содержит список ограничений на инструкции (опциональный раздел);
- `Sets` — содержит инструкции (обязательный раздел).

`Arguments` — ассоциативный массив, который строке ставит в соответствие структуру,
описывающую аргумент инструкции.
Эта структура состоит из полей:
- `name` — мнемоника аргумента, например `rd`, `uimm`;
- `span` — расположение аргумента в инструкции;
- `display` — формат отображения аргумента в дизассемблированном коде.

`Fields` — ассоциативный массив, который строке ставит в соответствие структуру,
описывающую поле инструкции.
Полем инструкции называются биты по значениям которых
можно распознать инструкцию.
Эта структура состоит из полей:
- `name` — мнемоника поля, например `opcode`, `funct3`;
- `span` — расположение поля в инструкции;
- `value` — значения, с которым сравниваются биты для распознания.

`Restricts` — подобен `Fields`, но содержит ограничения,
которые описывают состояния,
при которых инструкция не считается валидной.
Структура ограничения состоит из полей:
- `span` — расположение образца в инструкции;
- `value` — значение, которое не может быть у образца.

`Sets` — список из множеств инструкций.
Каждое множество описывается полями:
- `name` — название расширения, например `I` или `Zifencei`;
- `size` — размер инструкций в множестве в битах, например у расширения `I` 32-бита, а у расширения `C` — 16;
- `depth` — в какой разрядности (RV32 / RV64) инструкции в множестве имеют смысл, например `32` или `32|64|128`;
- `instructions` — список с описаниями инструкций

Каждая инструкция описываетмя следующими полями:
- `mnemonic` — мнемоника инструкции, например `addi` или `c.j` (обязательно)
- `fields` — список строк, отсылающие к значениям из `Fields` (обязательно)
- `args` — список строк, отсылающие к значениям `Args`
- `restricts` — список строк, отсылающие к значениям `Restricts`
- `format` — формат отображения аргументов,
  по умолчанию аргументы перечисляются через запятую,
  но иногда нужен другой формат, например `_, _(_)`
- `jump` — если этого поля нет, считается,
  что инструкция не влияет на поток управления,
  если стоит значение `out`,
  считается, что невозможно отследить переход при дизассемблировании,
  если стоит число, то это число — номер аргумента,
  значение которого и является смещением перехода.

Примечания:
- В частях `Arguments`, `Fields` и `Restricts`
  перечисляются все значения, используемые в файле,
  затем на эти значения ссылаются описания инструкций
  по строковому ключу.
- Одно RISC-V расширение может быть разбито на несколько множеств инструкций,
  например, если в расширении есть инструкции, такие как `slli`,
  зависящие от разрядности.

## Формат `span`

```
span ::= range | range ',' span;
range ::= number | number ':' number;
number ::= { '0' .. '9' };
```

Поле `span` в некоторых структурах позволяет
вычленить из битового представления инструкции
отдельные биты для дальнейшего стравнения
или интерпретации.

В грамматике выше:
- `number` — это индекс бита.
  Отсчёт ведётся с нуля с младшего бита,
  иначе говоря со стороны, на которой находится
  `opcode` в 32-битных инструкциях.
- `range` — это отрезок из индексов,
  который может состоять как из одного индекса,
  так и из нескольких. Например отрезок `7:11`
  содержит индексы `7,8,9,10,11`.
- `span` — последовательность из индексов,
  собранная из отрезков. Эта последовательность
  может быть как угодно разорвана и перемешана
  (см. описание аргументов в файле [c.yml](./c.yml)),
  что позволяет гибко выделять биты из инструкции.

Примечание: подразумевается,
что все последовательности битов,
идут <u>от младшего к старшему</u>.

Для примера:
```
Начальная последовательность:
  11001010 00111101 00110010 10010100
  ↑                                 ↑
  0-й бит                    31-й бит

span:
  21:30,20,12:19,31
   ↓↓↓
  21,22,23,24,25,26,27,28,
  29,30,20,12,13,14,15,16,
  17,18,19,31

Вычлененная последовательность:
  01010010100110100110
  ↑                  ↑
  0-й бит     20-й бит

Как число она будет интерпретирована как
  01100101100101001010 (binary)
  ↑                  ↑
  20-й бит     0-й бит
   ↓↓↓
  416074 (decimal)
```
